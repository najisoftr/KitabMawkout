@page "/"
@implements IDisposable
@inject NavigationManager Nav
@inject MySettingsRepo MySettingsRepo

@if (settings is not null)
{
    <div class="row">
        @if (settings is not null && prayersTimes is not null)
        {
            <div class="col-6">
                <PrayersTimeComp settings="settings" prayersTimes="prayersTimes" nextPrayerName="@nextPrayerName"/>
            </div>

            <div class="col-6">
                <PrayInfoComp nextPrayerName="@nextPrayerName"
                              countDownToNextPrayer="@countDownToNextPrayer"
                              nowToday="nowToday"
                              mySetting="settings"
                              Chourouk="@chourouk.ToString("HH:mm")"
                              prayersTimes="prayersTimes" />
            </div>
        }
        else
        {
            <div class="rz-m-12">
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" AriaLabel="Loading progress" />
            </div>
        }

    </div>
}


@code {
    // --- State Variables ---

    private MySetting? settings = null;
    private PrayerTimes? prayersTimes;
    private DateTime chourouk;
    private DateTime nowToday;
    private string nextPrayerName = "";
    private TimeSpan countDownToNextPrayer;

    private PeriodicTimer? timer;
    private bool running = true;

    // --- Lifecycle Methods ---

    protected override async Task OnInitializedAsync()
    {
        var settingVm = await MySettingsRepo.GetSettingAsync();
        // Check if settings exist and have been populated
        if (settingVm == null || string.IsNullOrWhiteSpace(settingVm.DesMasjid))
            Nav.NavigateTo("/settings");

        settings = new MySetting
        {
            DesMasjid = settingVm!.DesMasjid,
            Latitude = settingVm.Latitude,
            Longitude = settingVm.Longitude,
            MyCalculationMethode = settingVm.MyCalculationMethode,
            MyMadhab = settingVm.MyMadhab,
            MySettingsId = 1,
            TimeZoneId = settingVm.TimeZoneId
        };

        // First load of today's prayer times
        await LoadPrayersTimes(DateTime.Now);

        // Now start the timer
        timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
        _ = RunTimerLoop();
    }

    public void Dispose()
    {
        running = false;
        timer?.Dispose();
    }

    // --- Timer Loop and Data Loading ---

    private async Task RunTimerLoop()
    {
        while (running && timer is not null && await timer.WaitForNextTickAsync())
        {
            nowToday = DateTime.Now;
            await LoadPrayersTimes(nowToday);
            UpdateNextPrayerInfo();

            // // Check for midnight to load the next day's times
            // if (nowToday.Hour == 0 && nowToday.Minute == 0 && nowToday.Second == 0)
            // {
            //     await LoadPrayersTimes(nowToday);
            // }

            await InvokeAsync(StateHasChanged);
        }
    }


    /// <summary>
    /// Calculates prayer times for a specific date.
    /// NOTE: Ensure your Prayer enum values match those used here (e.g., Prayer.SUNRISE)
    /// </summary>
    private Task LoadPrayersTimes(DateTime date)
    {
        var coordinates = new Coordinates(settings!.Latitude ?? 0.0, settings!.Longitude ?? 0.0);
        Madhab madhab = settings.MyMadhab ?? new();
        CalculationMethod calcMethod = settings.MyCalculationMethode ?? new();
        CalculationParameters parameters = CalculationMethodExtensions.GetParameters(calcMethod);
        parameters.Madhab = madhab;

        // Ensure the DateComponents is built from the specific date parameter
        string timez = settings.TimeZoneId!;
        var myDate = new DateComponents(date.Year, date.Month, date.Day);
        
        prayersTimes = new PrayerTimes(coordinates, myDate, parameters);
        //convert prayer times to local time zone
        

        // Sunrise (Chourouk) for today
        DateTime? sunriseUtc = prayersTimes.TimeForPrayer(Prayer.SUNRISE);
        if (sunriseUtc.HasValue)
        {
            chourouk = TimeConvertToLocal.ConvertToLocal(sunriseUtc.Value, timez);
        }
        return Task.CompletedTask;
    }

    // --- Core Logic: Finding Next Prayer and Countdown (Manual/Deterministic) ---

    private void UpdateNextPrayerInfo()
    {
        if (prayersTimes == null || settings == null)
            return;

        // The current time is already set by the timer loop: nowToday = DateTime.Now;
        string timeZoneId = settings.TimeZoneId!;

        // 1. Define all prayer names and retrieve their times (converted to Local Time)
        var prayerMap = new List<(string Name, DateTime Time)>
        {
            ("FAJR",     TimeConvertToLocal.ConvertToLocal(prayersTimes.TimeForPrayer(Prayer.FAJR) ?? DateTime.MinValue, timeZoneId)),
            ("SUNRISE",  TimeConvertToLocal.ConvertToLocal(prayersTimes.TimeForPrayer(Prayer.SUNRISE) ?? DateTime.MinValue, timeZoneId)),
            ("DHUHR",    TimeConvertToLocal.ConvertToLocal(prayersTimes.TimeForPrayer(Prayer.DHUHR) ?? DateTime.MinValue, timeZoneId)),
            ("ASR",      TimeConvertToLocal.ConvertToLocal(prayersTimes.TimeForPrayer(Prayer.ASR) ?? DateTime.MinValue, timeZoneId)),
            ("MAGHRIB",  TimeConvertToLocal.ConvertToLocal(prayersTimes.TimeForPrayer(Prayer.MAGHRIB) ?? DateTime.MinValue, timeZoneId)),
            ("ISHA",     TimeConvertToLocal.ConvertToLocal(prayersTimes.TimeForPrayer(Prayer.ISHA) ?? DateTime.MinValue, timeZoneId))
        };

        // Filter out invalid times and sort them (though they should be sorted by the map above)
        var todayPrayers = prayerMap
            .Where(p => p.Time != DateTime.MinValue)
            .OrderBy(p => p.Time)
            .ToList();


        // 2. Find the next prayer by iterating through the sorted list

        (string name, DateTime time) nextPrayer = ("Error", DateTime.MinValue);
        bool foundToday = false;

        foreach (var prayer in todayPrayers)
        {
            // Use a slight tolerance (1 second) to ensure we move past the exact boundary
            // This is the key change to guarantee transition.
            if (prayer.Time.AddSeconds(1) > nowToday)
            {
                nextPrayer = (prayer.Name, prayer.Time);
                foundToday = true;
                break;
            }
        }

        // 3. Handle Rollover (No prayers found in the future today)

        if (!foundToday)
        {
            // Next prayer is tomorrow's Fajr.

            DateTime tomorrow = DateTime.Now.AddDays(1);
            var coordinates = new Coordinates(settings.Latitude ?? 0.0, settings.Longitude ?? 0.0);
            Madhab madhab = settings.MyMadhab ?? new();
            CalculationMethod calcMethod = settings.MyCalculationMethode ?? new();
            CalculationParameters parameters = CalculationMethodExtensions.GetParameters(calcMethod);
            parameters.Madhab = madhab;
            var tomorrowDate = new DateComponents(tomorrow.Year, tomorrow.Month, tomorrow.Day);

            // Calculate tomorrow's times (temporarily)
            PrayerTimes tomorrowPrayers = new PrayerTimes(coordinates, tomorrowDate, parameters);
            DateTime? tomorrowFajrUtc = tomorrowPrayers.TimeForPrayer(Prayer.FAJR);

            if (tomorrowFajrUtc.HasValue)
            {
                DateTime tomorrowFajrLocal = TimeConvertToLocal.ConvertToLocal(tomorrowFajrUtc.Value, timeZoneId);
                nextPrayer = ("FAJR2", tomorrowFajrLocal);
            }
            else
            {
                nextPrayerName = "Error: Fajr Not Found";
                countDownToNextPrayer = TimeSpan.Zero;
                return;
            }
        }


        // 4. Update component properties

        nextPrayerName = nextPrayer.name;

        // The countdown is calculated from the next prayer time to the current local time.
        countDownToNextPrayer = nextPrayer.time - nowToday;

        // Safety check: if TotalSeconds is negative (due to transition), reset to zero.
        if (countDownToNextPrayer.TotalSeconds < 0)
        {
            countDownToNextPrayer = TimeSpan.Zero;
        }
    }
}