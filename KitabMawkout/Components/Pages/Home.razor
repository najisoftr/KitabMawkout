@page "/"
@implements IDisposable
@inject NavigationManager Nav
@inject MySettingsRepo MySettingsRepo

@if(settings is not null)
{
    <div class="row">
        @if(settings is not null && prayersTimes is not null)
        {
            <div class="col-6">
                <PrayersTimeComp settings="settings" prayersTimes="prayersTimes"/>    
            </div>

            <div class="col-6">
                <PrayInfoComp
                    nextPrayerName="@nextPrayerName"
                    countDownToNextPrayer="@countDownToNextPrayer" 
                    nowToday="nowToday" 
                    mySetting="settings" 
                    Chourouk="@chourouk.ToString("HH:mm")" 
                    prayersTimes="prayersTimes"/>
            </div>    
        }
        else
        {
            <div class="rz-m-12">
                <RadzenProgressBar Value="100" ShowValue="false" Mode="ProgressBarMode.Indeterminate" AriaLabel="Loading progress" />
            </div>
        }

    </div>
}


@code{
    private MySetting? settings =null;
    private PrayerTimes? prayersTimes;
    private DateTime chourouk;
    private DateTime nowToday;
    private string nextPrayerName = "";
    private TimeSpan countDownToNextPrayer;

    private PeriodicTimer? timer;
    private bool running = true;
    private double progressValue;

    protected override async Task OnInitializedAsync()
    {
        var settingVm = await MySettingsRepo.GetSettingAsync();
        if(settingVm is null)
            Nav.NavigateTo("/settings");

        settings = new MySetting
            {
                DesMasjid = settingVm!.DesMasjid,
                Latitude = settingVm.Latitude,
                Longitude = settingVm.Longitude,
                MyCalculationMethode = settingVm.MyCalculationMethode,
                MyMadhab = settingVm.MyMadhab,
                MySettingsId = 1,
                TimeZoneId = settingVm.TimeZoneId
            };

        //first load
        await LoadPrayersTimes();
        //now start the timer
        timer = new PeriodicTimer(TimeSpan.FromSeconds(1));
        _ = RunTimerLoop();
    }

    private async Task RunTimerLoop()
    {
        while(running && timer is not null && await timer.WaitForNextTickAsync())
        {
            nowToday = DateTime.Now;
            UpdateNextPrayerInfo();
            if (nowToday.Hour == 0 && nowToday.Minute == 0 && nowToday.Second == 0)
                await LoadPrayersTimes();
                await InvokeAsync(StateHasChanged);
        }
    }


    //calculat prayers times
    private Task LoadPrayersTimes()
    {
        var coordinates = new Coordinates(settings!.Latitude??0.0, settings!.Longitude??0.0);
        Madhab madhab = settings.MyMadhab?? new();
        CalculationMethod calcMethod = settings.MyCalculationMethode?? new();        
        CalculationParameters parameters = CalculationMethodExtensions.GetParameters(calcMethod);
        parameters.Madhab = madhab;
        var myDate = new DateComponents(DateTime.Now.Year, DateTime.Now.Month, DateTime.Now.Day);
        string timez = settings.TimeZoneId;
        prayersTimes = new PrayerTimes(coordinates, myDate,parameters);        
        chourouk=TimeConvertToLocal.ConvertToLocal(prayersTimes.Sunrise, timez);
        nowToday = DateTime.Now;
        return Task.CompletedTask;
    }

    private void UpdateNextPrayerInfo()
    {
        if (prayersTimes == null || settings == null)
            return;

        // 1. Get next prayer enum
        Prayer next = prayersTimes.NextPrayer(nowToday);
        //Prayer next = prayersTimes.CurrentPrayer(nowToday);

        // If done for today
        if (next == Prayer.NONE)
        {
            nextPrayerName = "";
            countDownToNextPrayer = TimeSpan.Zero;
            return;
        }

        nextPrayerName = next.ToString();

        // 2. Get the next prayer time
        DateTime? nextTime = prayersTimes.TimeForPrayer(next);

        // 3. Convert to local time
        DateTime nextLocal = TimeConvertToLocal.ConvertToLocal(nextTime ?? DateTime.Now, settings.TimeZoneId);

        // 4. Countdown
        countDownToNextPrayer = nextLocal - nowToday;

        if (countDownToNextPrayer.TotalSeconds < 0)
            countDownToNextPrayer = TimeSpan.Zero;
    }


    //dispose the timer
    public void Dispose()
    {
        running = false;
        timer?.Dispose();
    }
}

